"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.simulateOrder = void 0;
async function simulateOrder(_, { data }, { clients: { checkoutExternal, market, decrypClient } }) {
    var _a;
    const items = [];
    data.items.forEach((element) => items.push(values(element)));
    function values(element) {
        const item = {
            id: element.id,
            quantity: element.quantity,
            seller: data.seller,
        };
        return item;
    }
    const list = [];
    const listLogistics = [];
    const index = [];
    const geoCoordinates = [];
    if (data.geoCoordinates != null) {
        const arrayDeCadenas = data.geoCoordinates.split(',');
        arrayDeCadenas.forEach((element) => {
            let a = element.replace('[', '');
            a = a.replace(']', '');
            geoCoordinates.push(a);
        });
    }
    const mket = await market.getMarket();
    let account = (mket === null || mket === void 0 ? void 0 : mket.haveParentAccount) ? mket === null || mket === void 0 ? void 0 : mket.parentAccountName : mket === null || mket === void 0 ? void 0 : mket.accountName;
    const getEmail = async () => {
        var _a, _b;
        const clientEmail = await decrypClient.decrypEmail(`?alias=${(_a = data === null || data === void 0 ? void 0 : data.clientProfileData) === null || _a === void 0 ? void 0 : _a.email}`, account);
        const { email } = clientEmail !== null && clientEmail !== void 0 ? clientEmail : await decrypClient.decrypEmail(`?alias=${(_b = data === null || data === void 0 ? void 0 : data.clientProfileData) === null || _b === void 0 ? void 0 : _b.email}`, data.sellerOrder);
        const _email = await decrypClient.decrypEmail(`?alias=${email}`, account);
        const userEmail = _email === null || _email === void 0 ? void 0 : _email.email;
        return userEmail !== null && userEmail !== void 0 ? userEmail : '';
    };
    const email = await getEmail();
    const request = {
        items,
        paymentData: {
            payments: [{
                    paymentSystem: data.paymentData
                }]
        },
        postalCode: data.postalCode,
        geoCoordinates,
        country: data.country,
        clientProfileData: { ...data === null || data === void 0 ? void 0 : data.clientProfileData, email }
    };
    const response = await checkoutExternal.simulation(request, account);
    let itemIndex = 0;
    response.items.forEach((element) => {
        if (element.availability == 'available') {
            element.itemIndex = itemIndex;
            itemIndex++;
            index.push(element.requestIndex);
            list.push(element);
        }
    });
    let itemIndexL = 0;
    (_a = response.logisticsInfo) === null || _a === void 0 ? void 0 : _a.forEach((element) => {
        if (index.includes(element.itemIndex)) {
            element.itemIndex = itemIndexL;
            itemIndexL++;
            listLogistics.push(element);
        }
    });
    const rta = {
        items: await list,
        paymentData: (await response).paymentData,
        postalCode: (await response).postalCode,
        country: (await response).country,
        messages: (await response).messages,
        logisticsInfo: await listLogistics,
        purchaseConditions: (await response).purchaseConditions,
        totals: (await response).totals,
    };
    return rta;
}
exports.simulateOrder = simulateOrder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ltdWxhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbm9kZS9taWRkbGV3YXJlcy9zaW11bGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHTyxLQUFLLFVBQVUsYUFBYSxDQUNqQyxDQUFNLEVBQ04sRUFBRSxJQUFJLEVBQTRCLEVBQ2xDLEVBQUUsT0FBTyxFQUFFLEVBQUUsZ0JBQWdCLEVBQUcsTUFBTSxFQUFFLFlBQVksRUFBQyxFQUFXOztJQUVoRSxNQUFNLEtBQUssR0FBNEQsRUFBRSxDQUFBO0lBRXpFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDNUQsU0FBUyxNQUFNLENBQUMsT0FBWTtRQUMxQixNQUFNLElBQUksR0FBRztZQUNYLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRTtZQUNkLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtZQUMxQixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07U0FDcEIsQ0FBQTtRQUVELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELE1BQU0sSUFBSSxHQUFlLEVBQUUsQ0FBQTtJQUMzQixNQUFNLGFBQWEsR0FBZSxFQUFFLENBQUE7SUFDcEMsTUFBTSxLQUFLLEdBQWMsRUFBRSxDQUFBO0lBQzNCLE1BQU0sY0FBYyxHQUFhLEVBQUUsQ0FBQTtJQUVuQyxJQUFJLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxFQUFFO1FBQy9CLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRXJELGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNqQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFD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VUFBVSxDQUFDO1lBQy9CLFVBQVUsRUFBRSxDQUFDO1lBQ2IsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUM1QjtJQUNILENBQUMsRUFBQztJQUVGLE1BQU0sR0FBRyxHQUFHO1FBQ1YsS0FBSyxFQUFFLE1BQU0sSUFBSTtRQUNqQixXQUFXLEVBQUUsQ0FBQyxNQUFNLFFBQVEsQ0FBQyxDQUFDLFdBQVc7UUFDekMsVUFBVSxFQUFFLENBQUMsTUFBTSxRQUFRLENBQUMsQ0FBQyxVQUFVO1FBQ3ZDLE9BQU8sRUFBRSxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUMsT0FBTztRQUNqQyxRQUFRLEVBQUUsQ0FBQyxNQUFNLFFBQVEsQ0FBQyxDQUFDLFFBQVE7UUFDbkMsYUFBYSxFQUFFLE1BQU0sYUFBYTtRQUNsQyxrQkFBa0IsRUFBRSxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUMsa0JBQWtCO1FBQ3ZELE1BQU0sRUFBRSxDQUFDLE1BQU0sUUFBUSxDQUFDLENBQUMsTUFBTTtLQUNoQyxDQUFBO0lBQ0QsT0FBTyxHQUFHLENBQUE7QUFDWixDQUFDO0FBN0ZELHNDQTZGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgU2ltdWxhdGlvbk9yZGVyRm9ybSB9IGZyb20gJy4uL2NsaWVudHMvdHlwaW5ncy9vcmRlckZvcm0nXG5pbXBvcnQgdHlwZSB7IENhcnRTaW11bGF0aW9uIH0gZnJvbSAnLi4vdHlwaW5ncy9jYXJ0X3NpbXVsYXRpb24nXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaW11bGF0ZU9yZGVyKFxuICBfOiBhbnksXG4gIHsgZGF0YSB9OiB7IGRhdGE6IENhcnRTaW11bGF0aW9uIH0sXG4gIHsgY2xpZW50czogeyBjaGVja291dEV4dGVybmFsICwgbWFya2V0LCBkZWNyeXBDbGllbnR9IH06IENvbnRleHRcbikge1xuICBjb25zdCBpdGVtczogQXJyYXk8eyBpZDogc3RyaW5nOyBxdWFudGl0eTogbnVtYmVyOyBzZWxsZXI6IHN0cmluZyB9PiA9IFtdXG5cbiAgZGF0YS5pdGVtcy5mb3JFYWNoKChlbGVtZW50KSA9PiBpdGVtcy5wdXNoKHZhbHVlcyhlbGVtZW50KSkpXG4gIGZ1bmN0aW9uIHZhbHVlcyhlbGVtZW50OiBhbnkpIHtcbiAgICBjb25zdCBpdGVtID0ge1xuICAgICAgaWQ6IGVsZW1lbnQuaWQsXG4gICAgICBxdWFudGl0eTogZWxlbWVudC5xdWFudGl0eSxcbiAgICAgIHNlbGxlcjogZGF0YS5zZWxsZXIsXG4gICAgfVxuXG4gICAgcmV0dXJuIGl0ZW1cbiAgfVxuXG4gIGNvbnN0IGxpc3Q6IEFycmF5PGFueT4gPSBbXVxuICBjb25zdCBsaXN0TG9naXN0aWNzOiBBcnJheTxhbnk+ID0gW11cbiAgY29uc3QgaW5kZXg6IHN0cmluZyBbXSA9IFtdXG4gIGNvbnN0IGdlb0Nvb3JkaW5hdGVzOiBzdHJpbmdbXSA9IFtdXG5cbiAgaWYgKGRhdGEuZ2VvQ29vcmRpbmF0ZXMgIT0gbnVsbCkge1xuICAgIGNvbnN0IGFycmF5RGVDYWRlbmFzID0gZGF0YS5nZW9Db29yZGluYXRlcy5zcGxpdCgnLCcpXG5cbiAgICBhcnJheURlQ2FkZW5hcy5mb3JFYWNoKChlbGVtZW50KSA9PiB7XG4gICAgICBsZXQgYSA9IGVsZW1lbnQucmVwbGFjZSgnWycsICcnKVxuXG4gICAgICBhID0gYS5yZXBsYWNlKCddJywgJycpXG4gICAgICBnZW9Db29yZGluYXRlcy5wdXNoKGEpXG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IG1rZXQgPSBhd2FpdCBtYXJrZXQuZ2V0TWFya2V0KClcbiAgbGV0IGFjY291bnQgPSBta2V0Py5oYXZlUGFyZW50QWNjb3VudCA/IG1rZXQ/LnBhcmVudEFjY291bnROYW1lIDogbWtldD8uYWNjb3VudE5hbWUgO1xuXG5cbiAgY29uc3QgZ2V0RW1haWwgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgY2xpZW50RW1haWwgPSBhd2FpdCBkZWNyeXBDbGllbnQuZGVjcnlwRW1haWwoYD9hbGlhcz0ke2RhdGE/LmNsaWVudFByb2ZpbGVEYXRhPy5lbWFpbH1gLCBhY2NvdW50KVxuICAgIGNvbnN0IHsgZW1haWwgfSA9IGNsaWVudEVtYWlsID8/IGF3YWl0IGRlY3J5cENsaWVudC5kZWNyeXBFbWFpbChgP2FsaWFzPSR7ZGF0YT8uY2xpZW50UHJvZmlsZURhdGE/LmVtYWlsfWAsIGRhdGEuc2VsbGVyT3JkZXIpXG4gICAgY29uc3QgX2VtYWlsID0gIGF3YWl0IGRlY3J5cENsaWVudC5kZWNyeXBFbWFpbChgP2FsaWFzPSR7ZW1haWx9YCwgYWNjb3VudClcbiAgICBjb25zdCB1c2VyRW1haWwgPSBfZW1haWw/LmVtYWlsXG5cbiAgICByZXR1cm4gdXNlckVtYWlsID8/ICcnXG4gIH1cblxuICBjb25zdCBlbWFpbCA9IGF3YWl0IGdldEVtYWlsKClcblxuICBjb25zdCByZXF1ZXN0ID0ge1xuICAgIGl0ZW1zLFxuICAgIHBheW1lbnREYXRhIDoge1xuICAgICAgcGF5bWVudHMgOiBbe1xuICAgICAgICBwYXltZW50U3lzdGVtIDogZGF0YS5wYXltZW50RGF0YVxuICAgIH1dXG4gICAgfSxcbiAgICBwb3N0YWxDb2RlOiBkYXRhLnBvc3RhbENvZGUsXG4gICAgZ2VvQ29vcmRpbmF0ZXMsXG4gICAgY291bnRyeTogZGF0YS5jb3VudHJ5LFxuICAgIGNsaWVudFByb2ZpbGVEYXRhOiB7Li4uZGF0YT8uY2xpZW50UHJvZmlsZURhdGEsIGVtYWlsfVxuICB9XG5cbiAgY29uc3QgcmVzcG9uc2U6IFNpbXVsYXRpb25PcmRlckZvcm0gPSBhd2FpdCBjaGVja291dEV4dGVybmFsLnNpbXVsYXRpb24ocmVxdWVzdCAsIGFjY291bnQpXG5cbiAgbGV0IGl0ZW1JbmRleCA9IDA7XG4gIHJlc3BvbnNlLml0ZW1zLmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4ge1xuICAgIGlmIChlbGVtZW50LmF2YWlsYWJpbGl0eSA9PSAnYXZhaWxhYmxlJykge1xuICAgICAgZWxlbWVudC5pdGVtSW5kZXggPSBpdGVtSW5kZXg7XG4gICAgICBpdGVtSW5kZXgrKztcbiAgICAgIGluZGV4LnB1c2goZWxlbWVudC5yZXF1ZXN0SW5kZXgpXG4gICAgICBsaXN0LnB1c2goZWxlbWVudClcbiAgICB9XG4gIH0pXG4gIGxldCBpdGVtSW5kZXhMID0gMDtcbiAgcmVzcG9uc2UubG9naXN0aWNzSW5mbz8uZm9yRWFjaCgoZWxlbWVudDogYW55KSA9PiB7XG4gICAgaWYgKGluZGV4LmluY2x1ZGVzKGVsZW1lbnQuaXRlbUluZGV4KSkge1xuICAgICAgZWxlbWVudC5pdGVtSW5kZXggPSBpdGVtSW5kZXhMO1xuICAgICAgaXRlbUluZGV4TCsrO1xuICAgICAgbGlzdExvZ2lzdGljcy5wdXNoKGVsZW1lbnQpXG4gICAgfVxuICB9KVxuXG4gIGNvbnN0IHJ0YSA9IHtcbiAgICBpdGVtczogYXdhaXQgbGlzdCxcbiAgICBwYXltZW50RGF0YTogKGF3YWl0IHJlc3BvbnNlKS5wYXltZW50RGF0YSxcbiAgICBwb3N0YWxDb2RlOiAoYXdhaXQgcmVzcG9uc2UpLnBvc3RhbENvZGUsXG4gICAgY291bnRyeTogKGF3YWl0IHJlc3BvbnNlKS5jb3VudHJ5LFxuICAgIG1lc3NhZ2VzOiAoYXdhaXQgcmVzcG9uc2UpLm1lc3NhZ2VzLFxuICAgIGxvZ2lzdGljc0luZm86IGF3YWl0IGxpc3RMb2dpc3RpY3MsXG4gICAgcHVyY2hhc2VDb25kaXRpb25zOiAoYXdhaXQgcmVzcG9uc2UpLnB1cmNoYXNlQ29uZGl0aW9ucyxcbiAgICB0b3RhbHM6IChhd2FpdCByZXNwb25zZSkudG90YWxzLFxuICB9XG4gIHJldHVybiBydGFcbn1cbiJdfQ==